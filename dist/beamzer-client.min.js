/*!
 * Example:
 *
 *         var beam = new BeamzerClient({
 *              source:"http://www.example.com/beamrays",
 *              params:{
 *                  id:"id"
 *              },
                options:{loggingEnabled:true, interval:4500}
 *         });
 *
 *         beam.start(function onOpen(e){ }, function onError(e){ }, function onMessage(e){ });
 *         beam.on("update", function(e){ });
 *         beam.on("noupdate", function(e){ });
 *         beam.newClient({source:"http://www.example.com/beamrays",params:{},options:{}});
 *         beam.off("update");
 *         beam.stop(function(e){ });
 *         
 */

!function(e){if(!e.EventSource||e._eventSourceImportPrefix){var t=(e._eventSourceImportPrefix||"")+"EventSource",n=function(e,t){if(!e||"string"!=typeof e)throw new SyntaxError("Not enough arguments");this.URL=e,this.setOptions(t);var n=this;setTimeout(function(){n.poll()},0)};if(n.prototype={CONNECTING:0,OPEN:1,CLOSED:2,defaultOptions:{loggingEnabled:!1,loggingPrefix:"eventsource",interval:500,bufferSizeLimit:262144,silentTimeout:3e5,getArgs:{evs_buffer_size_limit:262144},xhrHeaders:{Accept:"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","X-Requested-With":"XMLHttpRequest"}},setOptions:function(e){var t,n=this.defaultOptions;for(t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);for(t in e)t in n&&e.hasOwnProperty(t)&&(this[t]=e[t]);this.getArgs&&this.bufferSizeLimit&&(this.getArgs.evs_buffer_size_limit=this.bufferSizeLimit),"undefined"!=typeof console&&void 0!==console.log||(this.loggingEnabled=!1)},log:function(e){this.loggingEnabled&&console.log("["+this.loggingPrefix+"]:"+e)},poll:function(){try{if(this.readyState==this.CLOSED)return;this.cleanup(),this.readyState=this.CONNECTING,this.cursor=0,this.cache="",this._xhr=new this.XHR(this),this.resetNoActivityTimer()}catch(e){this.log("There were errors inside the pool try-catch"),this.dispatchEvent("error",{type:"error",data:e.message})}},pollAgain:function(e){var t=this;t.readyState=t.CONNECTING,t.dispatchEvent("error",{type:"error",data:"Reconnecting "}),this._pollTimer=setTimeout(function(){t.poll()},e||0)},cleanup:function(){this.log("evs cleaning up"),this._pollTimer&&(clearInterval(this._pollTimer),this._pollTimer=null),this._noActivityTimer&&(clearInterval(this._noActivityTimer),this._noActivityTimer=null),this._xhr&&(this._xhr.abort(),this._xhr=null)},resetNoActivityTimer:function(){if(this.silentTimeout){this._noActivityTimer&&clearInterval(this._noActivityTimer);var e=this;this._noActivityTimer=setTimeout(function(){e.log("Timeout! silentTImeout:"+e.silentTimeout),e.pollAgain()},this.silentTimeout)}},close:function(){this.readyState=this.CLOSED,this.log("Closing connection. readyState: "+this.readyState),this.cleanup()},_onxhrdata:function(){var e=this._xhr;if(e.isReady()&&!e.hasError()){this.resetNoActivityTimer(),this.readyState==this.CONNECTING&&(this.readyState=this.OPEN,this.dispatchEvent("open",{type:"open"}));var t=e.getBuffer();t.length>this.bufferSizeLimit&&(this.log("buffer.length > this.bufferSizeLimit"),this.pollAgain()),0==this.cursor&&t.length>0&&"\ufeff"==t.substring(0,1)&&(this.cursor=1);var n=this.lastMessageIndex(t);if(n[0]>=this.cursor){var r=n[1],i=t.substring(this.cursor,r);this.parseStream(i),this.cursor=r}e.isDone()&&(this.log("request.isDone(). reopening the connection"),this.pollAgain(this.interval))}else this.readyState!==this.CLOSED&&(this.log("this.readyState !== this.CLOSED"),this.pollAgain(this.interval))},parseStream:function(e){var t,n,r,o,s,a,l=(e=this.cache+this.normalizeToLF(e)).split("\n\n");for(t=0;t<l.length-1;t++){for(r="message",o=[],parts=l[t].split("\n"),n=0;n<parts.length;n++)0==(s=this.trimWhiteSpace(parts[n])).indexOf("event")?r=s.replace(/event:?\s*/,""):0==s.indexOf("retry")?(a=parseInt(s.replace(/retry:?\s*/,"")),isNaN(a)||(this.interval=a)):0==s.indexOf("data")?o.push(s.replace(/data:?\s*/,"")):0==s.indexOf("id:")?this.lastEventId=s.replace(/id:?\s*/,""):0==s.indexOf("id")&&(this.lastEventId=null);if(o.length){var u=new i(r,o.join("\n"),window.location.origin,this.lastEventId);this.dispatchEvent(r,u)}}this.cache=l[l.length-1]},dispatchEvent:function(e,t){var n=this["_"+e+"Handlers"];if(n)for(var r=0;r<n.length;r++)n[r].call(this,t);this["on"+e]&&this["on"+e].call(this,t)},addEventListener:function(e,t){this["_"+e+"Handlers"]||(this["_"+e+"Handlers"]=[]),this["_"+e+"Handlers"].push(t)},removeEventListener:function(e,t){var n=this["_"+e+"Handlers"];if(n)for(var r=n.length-1;r>=0;--r)if(n[r]===t){n.splice(r,1);break}},_pollTimer:null,_noactivityTimer:null,_xhr:null,lastEventId:null,cache:"",cursor:0,onerror:null,onmessage:null,onopen:null,readyState:0,urlWithParams:function(e,t){var n=[];if(t){var r,i,o=encodeURIComponent;for(r in t)t.hasOwnProperty(r)&&(i=o(r)+"="+o(t[r]),n.push(i))}return n.length>0?-1==e.indexOf("?")?e+"?"+n.join("&"):e+"&"+n.join("&"):e},lastMessageIndex:function(e){var t=e.lastIndexOf("\n\n"),n=e.lastIndexOf("\r\r"),r=e.lastIndexOf("\r\n\r\n");return r>Math.max(t,n)?[r,r+4]:[Math.max(t,n),Math.max(t,n)+2]},trimWhiteSpace:function(e){return e.replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")},normalizeToLF:function(e){return e.replace(/\r\n|\r/g,"\n")}},e.XDomainRequest&&e.XMLHttpRequest&&void 0===(new e.XMLHttpRequest).responseType){n.isPolyfill="IE_8-9";var r=n.prototype.defaultOptions;r.xhrHeaders=null,r.getArgs.evs_preamble=2056,n.prototype.XHR=function(e){request=new XDomainRequest,this._request=request,request.onprogress=function(){request._ready=!0,e._onxhrdata()},request.onload=function(){this._loaded=!0,e._onxhrdata()},request.onerror=function(){this._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"XDomainRequest error"})},request.ontimeout=function(){this._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"XDomainRequest timed out"})};var t={};if(e.getArgs){var n=e.getArgs;for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r]);e.lastEventId&&(t.evs_last_event_id=e.lastEventId)}request.open("GET",e.urlWithParams(e.URL,t)),request.send()},n.prototype.XHR.prototype={useXDomainRequest:!0,_request:null,_ready:!1,_loaded:!1,_failed:!1,isReady:function(){return this._request._ready},isDone:function(){return this._request._loaded},hasError:function(){return this._request._failed},getBuffer:function(){var e="";try{e=this._request.responseText||""}catch(e){}return e},abort:function(){this._request&&this._request.abort()}}}else n.isPolyfill="XHR",n.prototype.XHR=function(e){request=new XMLHttpRequest,this._request=request,e._xhr=this,request.onreadystatechange=function(){request.readyState>1&&e.readyState!=e.CLOSED&&(200==request.status||request.status>=300&&request.status<400?e._onxhrdata():(request._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"The server responded with "+request.status}),e.close()))},request.onprogress=function(){},request.open("GET",e.urlWithParams(e.URL,e.getArgs),!0);var t=e.xhrHeaders;for(var n in t)t.hasOwnProperty(n)&&request.setRequestHeader(n,t[n]);e.lastEventId&&request.setRequestHeader("Last-Event-Id",e.lastEventId),request.send()},n.prototype.XHR.prototype={useXDomainRequest:!1,_request:null,_failed:!1,isReady:function(){return this._request.readyState>=2},isDone:function(){return 4==this._request.readyState},hasError:function(){return this._failed||this._request.status>=400},getBuffer:function(){var e="";try{e=this._request.responseText||""}catch(e){}return e},abort:function(){this._request&&this._request.abort()}};e[t]=n}function i(e,t,n,r){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.data=t||null,this.origin=n||"",this.lastEventId=r||"",this.type=e||"message"}}(this||self),function(e,t,n){Array.prototype.indexOf=Array.prototype.indexOf||function(e){for(var t=this.length,n=0;n<t;n++)if(e===this[n])return n;return-1},Object.keys=Object.keys||function(e){var t,n=[];for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&n.push(t);return n},"undefined"!=typeof module&&module.exports?module.exports=t():"undefined"!=typeof define&&define.amd?define("BeamzerClient",t):void 0!==e&&e.window===e&&(e.BeamzerClient=t(e))}(this||self,function(e){if(e.EventSource){var t={},n=function(){},r="[object Function]",i=t.toString,o=t.hasOwnProperty,s=e.location,a=!function(e){try{e.setTimeout.apply(e,n)}catch(e){return!0}return!1}(e),l=s.origin+"/"||s.protocol+"//"+s.host+(s.port||"")+"/",u=/^(?:on|)?(?:open|error)/i,c=/^https?\:\/\/(?:([\w]+?)\.){1,2}(?:com|org|co\.uk|co|ca|co\.za|net|ng|com\.ng|gov|mil|biz|info|io|me|ng|mobi|name|edu|nti|aero|jobs|museumco\.za)\/?/,h=null,f=null,d=function(e,t){for(var n in e)o.call(e,n)&&t(e[n],n,e)},p=a||"poll"in e.EventSource.prototype&&"function"==typeof e.EventSource.prototype.poll,v={},y=function(){var t={},n={};return{getEvents:function(){return t},getProxy:function(e){return o.call(n,e)?n[e]:null},readyProxyObserver:function(e,r,i){var s;return o.call(n,r)||(n[r]={events:[],callback:function(n){var o=this;d(t,function(s,a){a.indexOf(n.type||e)>-1&&!i&&(a.match(u),1)&&t[a].call(o,n,r)})}}),(s=n[r]).events.push(e),s.callback},removeGlobalHandler:function(e){o.call(t,e)&&delete t[e]},addGlobalHandler:function(n){d(n,function(n,r){var i,s,a="";switch(r){case"open":case"error":case"message":a="on"}i=a+r,o.call(t,i)||"function"==typeof n&&(t[i]=(s=n,function(t,n){t.target.readyState===EventSource.CLOSED?"function"==typeof this.close&&(s.apply(null,[t,n]),e.console&&e.console.log("Stream Closed!")):t.target.readyState===EventSource.CONNECTING&&(e.console&&e.console.log("Stream Connecting..."),s.apply(null,[t,n]))}))})}}},g=function(e,t){var n,o=y.getEvents(),s=Object.keys(o);i.call(e.constructor)!==r?d(e,function(e,r){d(o,function(i,o){0==o.indexOf("on")?(n=o.replace("on",""),null===e[o]&&(e[o]=y.readyProxyObserver(n,r,t))):-1==s.indexOf(o)&&e.addEventListener(o,y.readyProxyObserver(o,r,t),!1)})}):d(o,function(r,i){0==i.indexOf("on")?(n=i.replace("on",""),null===e[i]&&(e[i]=y.readyProxyObserver(n,url,t))):-1==o.indexOf(i)&&e.addEventListener(i,y.readyProxyObserver(i,url,t),!1)})},m=function(e,t){var n,o=0,s=[],a=1*new Date;return i.call(e.constructor)!==r?d(e,function(e,t){null!==(n=y.getProxy(t))&&d(n.events,function(r){s.push(t),e.removeEventListener(r,n.callback),e.close(),++o})}):t&&null!==(n=y.getProxy(t))&&(s.push(t),n.events.indexOf(event)>-1&&e.removeEventListener(event,n.callback),e.close(),++o),e=null,function(e){"function"==typeof e&&e({type:"closed",timestamp:a,urls:s,closed_connections:o})}},_=function(e){if("object"!=typeof e)return!1;for(var t in e)if(o.call(e,t))return!1;return!0},E=function(t,n,r){var i=-1==n.indexOf("?")?"?":"";return t?(d(t,function(t,n){i+=r+e.encodeURIComponent(n)+"="+e.encodeURIComponent(t)+"&"}),n+(1==i.length)?"":i.replace(/\&$/,"")):""},O=function(t,n){var r=t.source||"",i=t.params||null,s=t.options||null,a=null;return c.exec(r)||(r=l+r),p?s.getArgs=i:r=E(i,r,""),"[object Object]"==String(s.headers)&&(r=E(s.headers,r,":")),!0===s.crossdomain&&(s.withCredentials=s.crossdomain,delete s.crossdomain),o.call(v,r)?(a=v[r],!0===n&&(_temp=m(a,r),a=_temp=null,a=new EventSource(r,s),g(a,null===s||!_(s)))):a=new EventSource(r,s),v[r]=a,this===e?new O(t,n):this},x=function(e,t){null===h&&(h=new O(e)),t&&(h=new O(e,t))};return O.prototype.disconnect=function(e){var t=m(v);return v={},t(e),null},O.prototype.on=function(e){y.addGlobalHandler(e),g(v)},O.prototype.off=function(e){y.removeGlobalHandler(e||"")},function e(t){return t||(t={}),this.url=t.source||"",x(t),null===f&&(f={constructor:e,start:function(e,t,n){h.on({open:e,error:t,message:n})},on:function(e,t){e.match(u)||(e=e.replace("on",""),h.on({event:t}))},off:function(e){h.off(e)},newClient:function(e){forceNew="object"==typeof e.params&&!_(e.params),x(e,forceNew)},stop:function(e){h.disconnect(e)}}),f}}});
