/*!
 * Example:
 *
 *         var beam = new BeamzerClient({
 *              source:"http://www.example.com/beamrays",
 *              params:{
 *                  id:"id"
 *              },
                options:{loggingEnabled:true, interval:4500}
 *         });
 *
 *         beam.open(function onOpen(e){ }, function onError(e){ }, function onMessage(e){ });
 *         beam.on("update", function(e){ });
 *         beam.on("noupdate", function(e){ });
 *         beam.new_client({source:"http://www.example.com/beamrays",params:{},options:{}});
 *         beam.off("update");
 *         beam.close(function(e){ });
 *         
 */

!function(e){function t(e,t,n,r){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.data=t||null,this.origin=n||"",this.lastEventId=r||"",this.type=e||"message"}function n(){return e.XDomainRequest&&e.XMLHttpRequest&&void 0===(new e.XMLHttpRequest).responseType?!0:!1}if(!e.EventSource||e._eventSourceImportPrefix){var r=(e._eventSourceImportPrefix||"")+"EventSource",i=function(e,t){if(!e||"string"!=typeof e)throw new SyntaxError("Not enough arguments");this.URL=e,this.setOptions(t);var n=this;setTimeout(function(){n.poll()},0)};if(i.prototype={CONNECTING:0,OPEN:1,CLOSED:2,defaultOptions:{loggingEnabled:!1,loggingPrefix:"eventsource",interval:500,bufferSizeLimit:262144,silentTimeout:3e5,getArgs:{evs_buffer_size_limit:262144},xhrHeaders:{Accept:"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","X-Requested-With":"XMLHttpRequest"}},setOptions:function(e){var t,n=this.defaultOptions;for(t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);for(t in e)t in n&&e.hasOwnProperty(t)&&(this[t]=e[t]);this.getArgs&&this.bufferSizeLimit&&(this.getArgs.evs_buffer_size_limit=this.bufferSizeLimit),("undefined"==typeof console||"undefined"==typeof console.log)&&(this.loggingEnabled=!1)},log:function(e){this.loggingEnabled&&console.log("["+this.loggingPrefix+"]:"+e)},poll:function(){try{if(this.readyState==this.CLOSED)return;this.cleanup(),this.readyState=this.CONNECTING,this.cursor=0,this.cache="",this._xhr=new this.XHR(this),this.resetNoActivityTimer()}catch(e){this.log("There were errors inside the pool try-catch"),this.dispatchEvent("error",{type:"error",data:e.message})}},pollAgain:function(e){var t=this;t.readyState=t.CONNECTING,t.dispatchEvent("error",{type:"error",data:"Reconnecting "}),this._pollTimer=setTimeout(function(){t.poll()},e||0)},cleanup:function(){this.log("evs cleaning up"),this._pollTimer&&(clearInterval(this._pollTimer),this._pollTimer=null),this._noActivityTimer&&(clearInterval(this._noActivityTimer),this._noActivityTimer=null),this._xhr&&(this._xhr.abort(),this._xhr=null)},resetNoActivityTimer:function(){if(this.silentTimeout){this._noActivityTimer&&clearInterval(this._noActivityTimer);var e=this;this._noActivityTimer=setTimeout(function(){e.log("Timeout! silentTImeout:"+e.silentTimeout),e.pollAgain()},this.silentTimeout)}},close:function(){this.readyState=this.CLOSED,this.log("Closing connection. readyState: "+this.readyState),this.cleanup()},_onxhrdata:function(){var e=this._xhr;if(e.isReady()&&!e.hasError()){this.resetNoActivityTimer(),this.readyState==this.CONNECTING&&(this.readyState=this.OPEN,this.dispatchEvent("open",{type:"open"}));var t=e.getBuffer();t.length>this.bufferSizeLimit&&(this.log("buffer.length > this.bufferSizeLimit"),this.pollAgain()),0==this.cursor&&t.length>0&&"\ufeff"==t.substring(0,1)&&(this.cursor=1);var n=this.lastMessageIndex(t);if(n[0]>=this.cursor){var r=n[1],i=t.substring(this.cursor,r);this.parseStream(i),this.cursor=r}e.isDone()&&(this.log("request.isDone(). reopening the connection"),this.pollAgain(this.interval))}else this.readyState!==this.CLOSED&&(this.log("this.readyState !== this.CLOSED"),this.pollAgain(this.interval))},parseStream:function(e){e=this.cache+this.normalizeToLF(e);var n,r,i,s,o,a,l=e.split("\n\n");for(n=0;n<l.length-1;n++){for(i="message",s=[],parts=l[n].split("\n"),r=0;r<parts.length;r++)o=this.trimWhiteSpace(parts[r]),0==o.indexOf("event")?i=o.replace(/event:?\s*/,""):0==o.indexOf("retry")?(a=parseInt(o.replace(/retry:?\s*/,"")),isNaN(a)||(this.interval=a)):0==o.indexOf("data")?s.push(o.replace(/data:?\s*/,"")):0==o.indexOf("id:")?this.lastEventId=o.replace(/id:?\s*/,""):0==o.indexOf("id")&&(this.lastEventId=null);if(s.length){var c=new t(i,s.join("\n"),window.location.origin,this.lastEventId);this.dispatchEvent(i,c)}}this.cache=l[l.length-1]},dispatchEvent:function(e,t){var n=this["_"+e+"Handlers"];if(n)for(var r=0;r<n.length;r++)n[r].call(this,t);this["on"+e]&&this["on"+e].call(this,t)},addEventListener:function(e,t){this["_"+e+"Handlers"]||(this["_"+e+"Handlers"]=[]),this["_"+e+"Handlers"].push(t)},removeEventListener:function(e,t){var n=this["_"+e+"Handlers"];if(n)for(var r=n.length-1;r>=0;--r)if(n[r]===t){n.splice(r,1);break}},_pollTimer:null,_noactivityTimer:null,_xhr:null,lastEventId:null,cache:"",cursor:0,onerror:null,onmessage:null,onopen:null,readyState:0,urlWithParams:function(e,t){var n=[];if(t){var r,i,s=encodeURIComponent;for(r in t)t.hasOwnProperty(r)&&(i=s(r)+"="+s(t[r]),n.push(i))}return n.length>0?-1==e.indexOf("?")?e+"?"+n.join("&"):e+"&"+n.join("&"):e},lastMessageIndex:function(e){var t=e.lastIndexOf("\n\n"),n=e.lastIndexOf("\r\r"),r=e.lastIndexOf("\r\n\r\n");return r>Math.max(t,n)?[r,r+4]:[Math.max(t,n),Math.max(t,n)+2]},trimWhiteSpace:function(e){var t=/^(\s|\u00A0)+|(\s|\u00A0)+$/g;return e.replace(t,"")},normalizeToLF:function(e){return e.replace(/\r\n|\r/g,"\n")}},n()){i.isPolyfill="IE_8-9";var s=i.prototype.defaultOptions;s.xhrHeaders=null,s.getArgs.evs_preamble=2056,i.prototype.XHR=function(e){request=new XDomainRequest,this._request=request,request.onprogress=function(){request._ready=!0,e._onxhrdata()},request.onload=function(){this._loaded=!0,e._onxhrdata()},request.onerror=function(){this._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"XDomainRequest error"})},request.ontimeout=function(){this._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"XDomainRequest timed out"})};var t={};if(e.getArgs){var n=e.getArgs;for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r]);e.lastEventId&&(t.evs_last_event_id=e.lastEventId)}request.open("GET",e.urlWithParams(e.URL,t)),request.send()},i.prototype.XHR.prototype={useXDomainRequest:!0,_request:null,_ready:!1,_loaded:!1,_failed:!1,isReady:function(){return this._request._ready},isDone:function(){return this._request._loaded},hasError:function(){return this._request._failed},getBuffer:function(){var e="";try{e=this._request.responseText||""}catch(t){}return e},abort:function(){this._request&&this._request.abort()}}}else i.isPolyfill="XHR",i.prototype.XHR=function(e){request=new XMLHttpRequest,this._request=request,e._xhr=this,request.onreadystatechange=function(){request.readyState>1&&e.readyState!=e.CLOSED&&(200==request.status||request.status>=300&&request.status<400?e._onxhrdata():(request._failed=!0,e.readyState=e.CLOSED,e.dispatchEvent("error",{type:"error",data:"The server responded with "+request.status}),e.close()))},request.onprogress=function(){},request.open("GET",e.urlWithParams(e.URL,e.getArgs),!0);var t=e.xhrHeaders;for(var n in t)t.hasOwnProperty(n)&&request.setRequestHeader(n,t[n]);e.lastEventId&&request.setRequestHeader("Last-Event-Id",e.lastEventId),request.send()},i.prototype.XHR.prototype={useXDomainRequest:!1,_request:null,_failed:!1,isReady:function(){return this._request.readyState>=2},isDone:function(){return 4==this._request.readyState},hasError:function(){return this._failed||this._request.status>=400},getBuffer:function(){var e="";try{e=this._request.responseText||""}catch(t){}return e},abort:function(){this._request&&this._request.abort()}};e[r]=i}}(this||self),function(e,t,n){Array.prototype.indexOf=Array.prototype.indexOf||function(e){for(var t=this,n=t.length,r=0;n>r;r++)if(e===t[r])return r;return-1},Object.keys=Object.keys||function(e){var t,n=[];for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&n.push(t);return n},"undefined"!=typeof module&&module.exports?module.exports=t():"undefined"!=typeof define&&define.amd?define("BeamzerClient",t):e!==n&&e.window===e&&(e.BeamzerClient=t(e))}(this||self,function(e){function t(e){return _makeClients(e),null===_instance&&(_instance={constructor:t,open:function(e,t,n){_clientsObject.on({open:e,error:t,message:n})},on:function(e,t){e.match(open_or_error)||(e=e.replace("on",""),_clientsObject.on({event:t}))},off:function(e){_clientsObject.off(e)},newClient:function(e){forceNew="object"==typeof e.params&&!_isEmpty(e.params),_makeClients(e,forceNew)},close:function(e){_clientsObject.disconnect(e)}}),_instance}if(e.EventSource){var n={},r=function(){},i="[object Function]",s=n.toString,o=n.hasOwnProperty,a=e.location,l=!function(e){try{e.setTimeout.apply(e,r)}catch(t){return!0}return!1}(e),c=a.origin||a.protocol+"//"+a.host+(a.port||"")+"/";return open_or_error=/^(?:on|)?(?:open|error)/i,rgx_url=/^https?\:\/\/(?:([\w]+?)\.){1,3}(?:com|au|co\.uk|org|net|gov|io|me|co\.za)\/?/,_clientsObject=null,_instance=null,_each=function(e,t){for(var n in e)o.call(e,n)&&t(e[n],n,e)},_isShim=l||"poll"in e.EventSource.prototype&&"function"==typeof e.EventSource.prototype.poll,connections={},EventsRegistry=function(){function t(t){var n=function(t){return function(t,n){t.target.readyState===EventSource.CLOSED?"function"==typeof this.close&&e.console&&e.console.log("Stream Closed!"):t.target.readyState===EventSource.CONNECTING&&e.console&&e.console.log("Stream Connecting...")}};_each(t,function(e,t){var r,i="";switch(t){case"open":case"error":case"message":i="on"}r=i+t,o.call(a,r)||"function"==typeof e&&(a[r]=n(e))})}function n(e){o.call(a,e)&&delete a[e]}function r(e,t,n){var r;return o.call(proxyList,t)||(l[t]={events:[],callback:function(r){var i=this;_each(a,function(s,o){o.indexOf(r.type||e)>-1&&(n||(o.match(open_or_error),0)||a[o].call(i,r,t))})}}),r=l[t],r.events.push(e),r.callback}function i(e){return o.call(proxyList,e)?proxyList[e]:null}function s(){return a}var a={},l={};return{getEvents:s,getProxy:i,readyProxyObserver:r,removeGlobalHandler:n,addGlobalHandler:t}},_installEvents=function(e,t){var n,r=EventsRegistry.getEvents(),o=Object.keys(r);s.call(e.constructor)!==i?_each(e,function(e,i){_each(r,function(r,s){0==s.indexOf("on")?(n=s.replace("on",""),null===e[s]&&(e[s]=EventsRegistry.readyProxyObserver(n,i,t))):-1==o.indexOf(s)&&e.addEventListener(s,EventsRegistry.readyProxyObserver(s,i,t),!1)})}):_each(r,function(i,s){0==s.indexOf("on")?(n=s.replace("on",""),null===e[s]&&(e[s]=EventsRegistry.readyProxyObserver(n,url,t))):-1==r.indexOf(s)&&e.addEventListener(s,EventsRegistry.readyProxyObserver(s,url,t),!1)})},_disconnect=function(e,t){var n,r=0,o=[],a=1*new Date;return s.call(e.constructor)!==i?_each(e,function(e,t){n=EventsRegistry.getProxy(t),null!==n&&_each(n.events,function(i){o.push(t),e.removeEventListener(i,n.callback),e.close(),++r})}):t&&(n=EventsRegistry.getProxy(t),null!==n&&(o.push(t),n.events.indexOf(event)>-1&&e.removeEventListener(event,n.callback),e.close(),++r)),e=null,function(e){"function"==typeof e&&e({type:"closed",timestamp:a,urls:o,closed_connections:r})}},_isEmpty=function(e){if("object"!=typeof e)return!1;for(var t in e)if(o.call(e,t))return!1;return!0},_objectToQuery=function(e){var t="?";return e?(_each(e,function(e,n){t+=encodeURIComponent(n)+"="+encodeURIComponent(e)+"&"}),1==t.length?"":t.replace(/\&$/,"")):""},Clients=function(t,n){var r=t.source||"",i=t.params||null,s=t.options||null,a=null;return rgx_url.exec(r)||(r=c+r),_isShim?s.getArgs=i:r+=_objectToQuery(i),o.call(connections,r)?(a=connections[r],n===!0&&(_temp=_disconnect(a,r),a=_temp=null,a=new EventSource(r,s),_installEvents(a,null===s||!_isEmpty(s)))):a=new EventSource(r,s),connections[r]=a,this===e?new Clients(t,n):this},_makeClients=function(e,t){null===_clientsObject&&(_clientsObject=new Clients(e)),t&&(_clientsObject=new Clients(e,t))},Clients.prototype.disconnect=function(e){var t=_disconnect(connections);return connections={},t(e),t=null},Clients.prototype.on=function(e){EventsRegistry.addGlobalHandler(e),_installEvents(connections)},Clients.prototype.off=function(e){evt=e||"",EventsRegistry.removeGlobalHandler(evt)},t}});
