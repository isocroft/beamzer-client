(function(n){var o="Handlers",u="error",e=!0,i="",t=null,r=!1;function c(n,u,f,e){var o=this;o.bubbles=r,o.cancelBubble=r,o.cancelable=r,o.data=u||t,o.origin=f||i,o.lastEventId=e||i,o.type=n||"message"}function l(){return window.XDomainRequest&&window.XMLHttpRequest&&(new XMLHttpRequest).responseType===undefined?e:r}var h,f,s;(!n.EventSource||n._eventSourceImportPrefix)&&(h=(n._eventSourceImportPrefix||i)+"EventSource",f=function(n,t){if(!n||typeof n!="string")throw new SyntaxError("Not enough arguments");this.URL=n,this.setOptions(t);var i=this;setTimeout(function(){i.poll()},0)},f.prototype={CONNECTING:0,OPEN:1,CLOSED:2,defaultOptions:{loggingEnabled:r,loggingPrefix:"eventsource",interval:500,bufferSizeLimit:262144,silentTimeout:3e5,getArgs:{evs_buffer_size_limit:262144},xhrHeaders:{Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"}},setOptions:function(n){var f="undefined",i=this,u=i.defaultOptions,t;for(t in u)u.hasOwnProperty(t)&&(i[t]=u[t]);for(t in n)t in u&&n.hasOwnProperty(t)&&(i[t]=n[t]);i.getArgs&&i.bufferSizeLimit&&(i.getArgs.evs_buffer_size_limit=i.bufferSizeLimit),(typeof console==f||typeof console.log==f)&&(i.loggingEnabled=r)},log:function(n){this.loggingEnabled&&console.log("["+this.loggingPrefix+"]:"+n)},poll:function(){var n=this;try{if(n.readyState==n.CLOSED)return;n.cleanup(),n.readyState=n.CONNECTING,n.cursor=0,n.cache=i,n._xhr=new n.XHR(n),n.resetNoActivityTimer()}catch(t){n.log("There were errors inside the pool try-catch"),n.dispatchEvent(u,{type:u,data:t.message})}},pollAgain:function(n){var t=this;t.readyState=t.CONNECTING,t.dispatchEvent(u,{type:u,data:"Reconnecting "}),this._pollTimer=setTimeout(function(){t.poll()},n||0)},cleanup:function(){var n=this;n.log("evs cleaning up"),n._pollTimer&&(clearInterval(n._pollTimer),n._pollTimer=t),n._noActivityTimer&&(clearInterval(n._noActivityTimer),n._noActivityTimer=t),n._xhr&&(n._xhr.abort(),n._xhr=t)},resetNoActivityTimer:function(){var n=this;if(n.silentTimeout){n._noActivityTimer&&clearInterval(n._noActivityTimer);var t=n;n._noActivityTimer=setTimeout(function(){t.log("Timeout! silentTImeout:"+t.silentTimeout),t.pollAgain()},n.silentTimeout)}},close:function(){var n=this;n.readyState=n.CLOSED,n.log("Closing connection. readyState: "+n.readyState),n.cleanup()},_onxhrdata:function(){var n=this,i=n._xhr,t,r,u,f;i.isReady()&&!i.hasError()?(n.resetNoActivityTimer(),n.readyState==n.CONNECTING&&(n.readyState=n.OPEN,n.dispatchEvent("open",{type:"open"})),t=i.getBuffer(),t.length>n.bufferSizeLimit&&(n.log("buffer.length > this.bufferSizeLimit"),n.pollAgain()),n.cursor==0&&t.length>0&&t.substring(0,1)=="﻿"&&(n.cursor=1),r=n.lastMessageIndex(t),r[0]>=n.cursor&&(u=r[1],f=t.substring(n.cursor,u),n.parseStream(f),n.cursor=u),i.isDone()&&(n.log("request.isDone(). reopening the connection"),n.pollAgain(n.interval))):n.readyState!==n.CLOSED&&(n.log("this.readyState !== this.CLOSED"),n.pollAgain(n.interval))},parseStream:function(n){var u=this,f,e,o,s,h,r,l,a;for(n=u.cache+u.normalizeToLF(n),f=n.split("\n\n"),e=0;e<f.length-1;e++){for(s="message",h=[],parts=f[e].split("\n"),o=0;o<parts.length;o++)r=u.trimWhiteSpace(parts[o]),r.indexOf("event")==0?s=r.replace(/event:?\s*/,i):r.indexOf("retry")==0?(l=parseInt(r.replace(/retry:?\s*/,i)),isNaN(l)||(u.interval=l)):r.indexOf("data")==0?h.push(r.replace(/data:?\s*/,i)):r.indexOf("id:")==0?u.lastEventId=r.replace(/id:?\s*/,i):r.indexOf("id")==0&&(u.lastEventId=t);h.length&&(a=new c(s,h.join("\n"),window.location.origin,u.lastEventId),u.dispatchEvent(s,a))}u.cache=f[f.length-1]},dispatchEvent:function(n,t){var i=this,u=i["_"+n+o],r;if(u)for(r=0;r<u.length;r++)u[r].call(i,t);i["on"+n]&&i["on"+n].call(i,t)},addEventListener:function(n,t){this["_"+n+o]||(this["_"+n+o]=[]),this["_"+n+o].push(t)},removeEventListener:function(n,t){var r=this["_"+n+o],i;if(r)for(i=r.length-1;i>=0;--i)if(r[i]===t){r.splice(i,1);break}},_pollTimer:t,_noactivityTimer:t,_xhr:t,lastEventId:t,cache:i,cursor:0,onerror:t,onmessage:t,onopen:t,readyState:0,urlWithParams:function(n,t){var i=[],r,f,u;if(t){u=encodeURIComponent;for(r in t)t.hasOwnProperty(r)&&(f=u(r)+"="+u(t[r]),i.push(f))}return i.length>0?n.indexOf("?")==-1?n+"?"+i.join("&"):n+"&"+i.join("&"):n},lastMessageIndex:function(n){var t=n.lastIndexOf("\n\n"),i=n.lastIndexOf("\r\r"),r=n.lastIndexOf("\r\n\r\n");return r>Math.max(t,i)?[r,r+4]:[Math.max(t,i),Math.max(t,i)+2]},trimWhiteSpace:function(n){var t=/^(\s|\u00A0)+|(\s|\u00A0)+$/g;return n.replace(t,i)},normalizeToLF:function(n){return n.replace(/\r\n|\r/g,"\n")}},l()?(f.isPolyfill="IE_8-9",s=f.prototype.defaultOptions,s.xhrHeaders=t,s.getArgs.evs_preamble=2056,f.prototype.XHR=function(n){var t,i,r;if(request=new XDomainRequest,this._request=request,request.onprogress=function(){request._ready=e,n._onxhrdata()},request.onload=function(){this._loaded=e,n._onxhrdata()},request.onerror=function(){this._failed=e,n.readyState=n.CLOSED,n.dispatchEvent(u,{type:u,data:"XDomainRequest error"})},request.ontimeout=function(){this._failed=e,n.readyState=n.CLOSED,n.dispatchEvent(u,{type:u,data:"XDomainRequest timed out"})},t={},n.getArgs){i=n.getArgs;for(r in i)i.hasOwnProperty(r)&&(t[r]=i[r]);n.lastEventId&&(t.evs_last_event_id=n.lastEventId)}request.open("GET",n.urlWithParams(n.URL,t)),request.send()},f.prototype.XHR.prototype={useXDomainRequest:e,_request:t,_ready:r,_loaded:r,_failed:r,isReady:function(){return this._request._ready},isDone:function(){return this._request._loaded},hasError:function(){return this._request._failed},getBuffer:function(){var n=i;try{n=this._request.responseText||i}catch(t){}return n},abort:function(){this._request&&this._request.abort()}}):(f.isPolyfill="XHR",f.prototype.XHR=function(n){var t,i;request=new XMLHttpRequest,this._request=request,n._xhr=this,request.onreadystatechange=function(){request.readyState>1&&n.readyState!=n.CLOSED&&(request.status==200||request.status>=300&&request.status<400?n._onxhrdata():(request._failed=e,n.readyState=n.CLOSED,n.dispatchEvent(u,{type:u,data:"The server responded with "+request.status}),n.close()))},request.onprogress=function(){},request.open("GET",n.urlWithParams(n.URL,n.getArgs),e),t=n.xhrHeaders;for(i in t)t.hasOwnProperty(i)&&request.setRequestHeader(i,t[i]);n.lastEventId&&request.setRequestHeader("Last-Event-Id",n.lastEventId),request.send()},f.prototype.XHR.prototype={useXDomainRequest:r,_request:t,_failed:r,isReady:function(){return this._request.readyState>=2},isDone:function(){return this._request.readyState==4},hasError:function(){return this._failed||this._request.status>=400},getBuffer:function(){var n=i;try{n=this._request.responseText||i}catch(t){}return n},abort:function(){this._request&&this._request.abort()}}),n[h]=f)})(this);
/*!
 * Example:
 *
 *         var beam = new BeamzerClient({
 *              source:"http://www.example.com/beamrays",
 *              params:{
 *                  id:"id"
 *              },
                options:{loggingEnabled:true, interval:4500}
 *         });
 *
 *         beam.open(function(e){ }, function(e){ }, function(e){ });
 *         beam.on("update", function(e){ });
 *         beam.on("noupdate", function(e){ });
 *         beam.new_client({source:"http://www.example.com/beamrays",params:{},options:{}});
 *         beam.off("update");
 *         beam.close(function(e){ });
 *         
 */
(function(n,t,i){var r="undefined";Array.prototype.indexOf=Array.prototype.indexOf||function(n){for(var i=this,r=i.length,t=0;t<r;t++)if(n===i[t])return t;return-1},Object.keys=Object.keys||function(n){var t,i=[];for(t in n)!!n.hasOwnProperty&&n.hasOwnProperty(t)&&i.push(t);return i},typeof module==r||!module.exports?typeof define==r||!define.amd?n!==i&&n.window===n&&(n.BeamzerClient=t(n)):define("BeamzerClient",t):module.exports=t()})(this,function(n){var o="function",f=!1,e=!0,i="",u="on",t=null;function a(n){return _makeClients(n),_instance===t&&(_instance={constructor:a,open:function(n,t,i){_clientsObject.on({open:n,error:t,message:i})},on:function(n,t){if(!n.match(open_or_error)){n=n.replace(u,i);_clientsObject.on({event:t})}},off:function(n){_clientsObject.off(n)},new_client:function(n){forceNew=typeof n.params=="object"&&!_isEmpty(n.params),_makeClients(n,forceNew)},close:function(n){_clientsObject.disconnect(n)}}),_instance}if(n.EventSource){var w=[],h={},v=function(){},c="[object Function]",b=[i],l=h.toString,r=h.hasOwnProperty,k=n.document,s=n.location,y=!function(n){try{var t=n.setTimeout.apply(n,v)}catch(i){return e}return f}(n),d=/^function (.+(?=\())/i,p=s.origin||s.protocol+"//"+s.host+(s.port||i)+"/";return open_or_error=/^(?:on|)?(?:open|error)/i,rgx_url=/^https?\:\/\/(?:([\w]+?)\.){1,3}(?:com|au|co\.uk|org|net|gov|io|me|co\.za)\/?/,_clientsObject=t,_instance=t,_each=function(n,t){for(var i in n)r.call(n,i)&&t(n[i],i,n)},_isShim=y||"poll"in n.EventSource.prototype&&typeof n.EventSource.prototype.poll==o,connections={},EventsRegistry=function(){function s(t){var f=function(){return function(n){n.target.readyState===EventSource.CLOSED?typeof this.close==o&&console&&console.log("Stream Closed!"):n.target.readyState===EventSource.CONNECTING&&console&&console.log("Stream Connecting...")}};_each(t,function(t,e){var h=i,s;switch(e){case"open":case"error":case"message":h=u}s=h+e,r.call(n,s)||typeof t==o&&(n[s]=f(t))})}function h(t){r.call(n,t)&&delete n[t]}function c(t,i,u){var o;return r.call(proxyList,i)||(f[i]={events:[],callback:function(r){var f=this;_each(n,function(o,s){s.indexOf(r.type||t)>-1&&!u&&(s.match(open_or_error)||e)&&n[s].call(f,r,i)})}}),o=f[i],o.events.push(t),o.callback}function l(n){return r.call(proxyList,n)?proxyList[n]:t}function a(){return n}var n={},f={};return{getEvents:a,getProxy:l,readyProxyObserver:c,removeGlobalHandler:h,addGlobalHandler:s}},_installEvents=function(n,r){var e=EventsRegistry.getEvents(),s=Object.keys(e),o;l.call(n.constructor)!==c?_each(n,function(n,h){_each(e,function(e,c){c.indexOf(u)==0?(o=c.replace(u,i),n[c]===t&&(n[c]=EventsRegistry.readyProxyObserver(o,h,r))):s.indexOf(c)==-1&&n.addEventListener(c,EventsRegistry.readyProxyObserver(c,h,r),f)})}):_each(e,function(s,h){h.indexOf(u)==0?(o=h.replace(u,i),n[h]===t&&(n[h]=EventsRegistry.readyProxyObserver(o,url,r))):e.indexOf(h)==-1&&n.addEventListener(h,EventsRegistry.readyProxyObserver(h,url,r),f)})},_disconnect=function(n,i){var r,u=0,f=[],e=new Date*1;return l.call(n.constructor)!==c?_each(n,function(n,i){r=EventsRegistry.getProxy(i),r!==t&&_each(r.events,function(t){f.push(i),n.removeEventListener(t,r.callback),n.close(),++u})}):i&&(r=EventsRegistry.getProxy(i),r!==t&&(f.push(i),r.events.indexOf(event)>-1&&n.removeEventListener(event,r.callback),n.close(),++u)),n=t,function(n){typeof n==o&&n({type:"closed",timestamp:e,urls:f,closed_connections:u})}},_isEmpty=function(n){if(typeof n!="object")return f;for(var t in n)if(r.call(n,t))return f;return e},_objectToQuery=function(n){var t="?";return n?(_each(n,function(n,i){t+=encodeURIComponent(i)+"="+encodeURIComponent(n)+"&"}),t.length==1?i:t.replace(/\&$/,i)):i},Clients=function(u,f){var o=u.source||i,c=u.params||t,h=u.options||t,s=t;return rgx_url.exec(o)||(o=p+o),_isShim?h.getArgs=c:o=o+_objectToQuery(c),r.call(connections,o)?(s=connections[o],f===e&&(_temp=_disconnect(s,o),s=_temp=t,s=new EventSource(o,h),_installEvents(s,h===t||!_isEmpty(h)))):s=new EventSource(o,h),connections[o]=s,this===n?new Clients(u,f):this},_makeClients=function(n,i){_clientsObject===t&&(_clientsObject=new Clients(n)),i&&(_clientsObject=new Clients(n,i))},Clients.prototype.disconnect=function(n){var i=_disconnect(connections);return connections={},i(n),i=t},Clients.prototype.on=function(n){EventsRegistry.addGlobalHandler(n),_installEvents(connections)},Clients.prototype.off=function(n){evt=n||i,EventsRegistry.removeGlobalHandler(evt)},a}})